<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    
    <style>
    table {
        width:100%;
    }
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
    }
    th, td {
        padding: 5px;
        text-align: left;
    }
    table#t01 tr:nth-child(even) {
        background-color: #eee;
    }
    table#t01 tr:nth-child(odd) {
       background-color:#fff;
    }
    table#t01 th	{
        background-color: black;
        color: white;
    }
    </style>
    
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      
    <div id="dateSelect" style="float: right;"></div>
    <br clear="all" /><br clear="all" />
    
    Number of Users Per Category:
    <br /><br />
    <table id="t01">
    </table>
    
    <br clear="all" /><br clear="all" />
    
    <table id="t02">
    </table>
    </div>
    
    <script>
      /* 
      Requirements: 
      - Table 1:
      - Table 2: number of users in each category (beginner is 1-3)
      - Table 3: cumulative users ( beginner is > 1)
        - include conversion rate, i.e. the percentage of advanced who were beginner 
      */ 
      
      /* Variables */
      var eventName = '$custom_event:64721';
      var queriesComplete = 0;
      var dateSelect  = $('#dateSelect').MPDatepicker();

      /* Query */
      //TODO: want to run the query on load 
      var runQuery = function() {
        var dateRange = dateSelect.MPDatepicker('value');
        
         /* Segmentation Parameters */
        var beginnerParams = {
          to:dateRange.to,
          from:dateRange.from,
          type:'unique',
          unit:'month',
          frequency:(0,4)
        };
        var activeParams = {
          to:dateRange.to,
          from:dateRange.from,
          type:'unique',
          unit:'month',
          frequency:(3,20)
        };
        var engagedParams = {
          to:dateRange.to,
          from:dateRange.from,
          type:'unique',
          unit:'month',
          frequency:(19,80)
        };
        var highlyEngagedParams = {
          to:dateRange.to,
          from:dateRange.from,
          type:'unique',
          unit:'month',
          frequency:80
        };
        var finalStruct = [];
        
        // Number of users per category query
         MP.api.segment(eventName, null, beginnerParams).done(function(results) {
           // TODO: order results before pushing them in 
           finalStruct.push(results.values());
           MP.api.segment(eventName, null, activeParams).done(function(results2) {
             finalStruct.push(results2.values());
             MP.api.segment(eventName, null, engagedParams).done(function(results3) {
               finalStruct.push(results3.values());
               MP.api.segment(eventName, null, highlyEngagedParams).done(function(results4) {
                finalStruct.push(results4.values());
                calculateOutputs(finalStruct);
               });
             });
           });
         });
         
         // Number of users per category query cumulative table 
         
      };
      
      function calculateOutputs(outputStructure){
        // Print our data structure
        console.log(outputStructure);
        
        /* Build Table 1 */
        // Get table
        var table = document.getElementById("t01");
        
        // Delete previous rows
        while(table.rows.length > 0) {
          table.deleteRow(0);
        }
        
        // Build header
        var colCount = 0;
        var row = table.insertRow(0);
        row.style.color = "white";
        row.style.backgroundColor = "#595959";
        //row.id = "eventRow"+i;
        //row.className = "eventRow";
        for(var key in outputStructure[0][eventName]){
          var cell = row.insertCell(colCount);
          cell.innerHTML = key;
          colCount++;
        }
        
        // Build rows 
        for(var i = 0; i < outputStructure.length; i++){
          var row = table.insertRow(i+1);
          colCount = 0;
          for(var key in outputStructure[i][eventName]){
            var cell = row.insertCell(colCount);
            cell.innerHTML = outputStructure[i][eventName][key];
            if(i == 0){
              cell.style.backgroundColor = "#ffaa80";
            }
            else if (i== 1){
              cell.style.backgroundColor = "#ffff99";
            }
            else if(i== 2){
              cell.style.backgroundColor = "#99ddff";
            }
            else if (i ==3){
              cell.style.backgroundColor = "#99ff66";
            }
            colCount++;
          }
        }
        
        /* Build Table 2 */
        var table = document.getElementById("t02");
        
        // Delete previous rows
        while(table.rows.length > 0) {
          table.deleteRow(0);
        }

      }
      
      
      dateSelect.on('change', runQuery);
    </script>
  </body>
</html>
